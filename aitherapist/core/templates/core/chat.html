<!-- core/templates/core/chat.html -->
{% extends 'core/base.html' %}
{% load static %}

{% block title %}Chat - AI Therapist{% endblock %}

{% block main_class %}container-fluid h-100{% endblock %}

{% block main_wrapper %}
{% block content %}
<div class="row h-100 g-0">
    <!-- Chat History Sidebar (Hidden on mobile) -->
    <div class="col-md-3 col-lg-2 d-none d-md-block chat-history-sidebar h-100">
        <div class="h-100 d-flex flex-column" style="border-right: 1px solid var(--glass-border);">
            <div class="p-3" style="border-bottom: 1px solid var(--glass-border);">
                <h6 class="mb-0" style="color: var(--text-primary); font-weight: 600;">
                    <i class="bi bi-clock-history me-2"></i>Recent Conversations
                </h6>
            </div>
            <div class="chat-history scroll-area flex-grow-1"
                style="overflow-y: auto; overflow-x: hidden; padding: 0.5rem;">
                {% for conv in recent_conversations %}
                {% with last=conv.chats.first %}
                <div class="p-3 chat-history-item" data-conv-id="{{ conv.id }}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <p class="mb-1 text-truncate" style="max-width: 200px; color: var(--text-primary);">
                                {% if last %}{{ last.user_message|truncatechars:40 }}{% else %}New Conversation{% endif %}
                            </p>
                            <small class="text-muted">
                                {% if last %}{{ last.timestamp|timesince }} ago{% else %}Just now{% endif %}
                                {% if last and last.sentiment == 'positive' %}
                                <i class="bi bi-emoji-smile text-success ms-1"></i>
                                {% elif last and last.sentiment == 'negative' %}
                                <i class="bi bi-emoji-frown text-danger ms-1"></i>
                                {% else %}
                                <i class="bi bi-emoji-neutral text-muted ms-1"></i>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% empty %}
                <div class="p-3 text-center text-muted">
                    <i class="bi bi-chat-dots d-block mb-2" style="font-size: 2rem;"></i>
                    <p class="mb-0">No conversations yet.<br>Start your first chat!</p>
                </div>
                {% endfor %}
            </div>

            <!-- User Profile Section at Bottom -->
            <a href="{% url 'profile' %}" class="sidebar-profile-link text-decoration-none">
                <div class="sidebar-profile p-3 d-flex align-items-center justify-content-between"
                    style="border-top: 1px solid var(--glass-border); background: rgba(255, 255, 255, 0.03);">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle me-2 d-flex align-items-center justify-content-center"
                            style="width: 32px; height: 32px; background: rgba(255, 255, 255, 0.2);">
                            {% if user.userprofile.avatar %}
                            <img src="{{ user.userprofile.avatar.url }}" class="rounded-circle"
                                style="width: 32px; height: 32px; object-fit: cover;">
                            {% else %}
                            <i class="bi bi-person h-100 w-100 d-flex align-items-center justify-content-center"
                                style="color: var(--text-primary);"></i>
                            {% endif %}
                        </div>
                        <span class="text-truncate"
                            style="max-width: 100px; color: var(--text-primary); font-size: 0.9rem;">
                            {{ user.username }}
                        </span>
                    </div>
                    <i class="bi bi-chevron-right small" style="color: var(--text-secondary);"></i>
                </div>
            </a>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="col-md-9 col-lg-10">
        <div class="d-flex flex-column h-100 chat-main-column" data-conversation-id="{{ conversation.id }}">
            <!-- Chat Header -->
            <div class="chat-header-bar" style="border-bottom: 1px solid var(--glass-border); overflow: visible;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-2 me-3" style="background: rgba(255, 255, 255, 0.2);">
                                <i class="bi bi-robot" style="font-size: 1.5rem; color: var(--accent-blue);"></i>
                            </div>
                            <div>
                                <h5 class="mb-0" style="color: var(--text-primary);">AI Therapist</h5>
                                <small style="color: var(--text-secondary);">
                                    <i class="bi bi-circle-fill text-success me-1" style="font-size: 0.5rem;"></i>
                                    Always here to help
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="dropdown" style="position: relative;">
                                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots"></i> Extras
                                </button>
                                <ul class="dropdown-menu glassmorphic-dropdown dropdown-menu-end"
                                    style="position: absolute; z-index: 10000;">
                                    <li><a class="dropdown-item glassmorphic-dropdown-item" href="#" id="newChatBtn">
                                            <i class="bi bi-plus-lg me-2"></i>New Chat
                                        </a></li>
                                    <li>
                                    </li>
                                    <li><a class="dropdown-item glassmorphic-dropdown-item" href="#"
                                            id="getCopingStrategy"><i class="bi bi-lightbulb me-2"></i>Get Coping
                                            Strategy</a></li>
                                    <li><a class="dropdown-item glassmorphic-dropdown-item"
                                            href="{% url 'dashboard' %}"><i class="bi bi-graph-up me-2"></i>View
                                            Dashboard</a></li>
                                    <li>
                                    </li>
                                    <li><a class="dropdown-item glassmorphic-dropdown-item" href="#" id="clearChat"><i
                                                class="bi bi-trash me-2"></i>Clear Chat</a>
                                    </li>
                                    <form method="POST" action="{% url 'logout' %}">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item glassmorphic-dropdown-item">
                                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                                        </button>
                                    </form>
                                </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="flex-grow-1 p-4 scroll-area" id="messagesContainer"
                style="height: calc(100vh - 300px); overflow-y: auto; background: rgba(255, 255, 255, 0.05);">
                <div id="chatMessages">
                    <!-- Welcome Message -->
                    <div class="message-wrapper mb-3">
                        <div class="d-flex align-items-start">
                            <div class="rounded-circle p-2 me-3 flex-shrink-0"
                                style="background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);">
                                <i class="bi bi-robot text-white"></i>
                            </div>
                            <div class="message-content card flex-grow-1">
                                <div class="card-body">
                                    <p class="mb-2" style="color: var(--text-primary);">
                                        Hello {{ user.first_name|default:user.username }}! ðŸ‘‹ I'm your AI therapist,
                                        here to provide a safe space for you to share your thoughts and feelings.
                                    </p>
                                    <p class="mb-2" style="color: var(--text-primary);">
                                        Whether you're feeling stressed, anxious, happy, or anything in between, I'm
                                        here to listen and offer support.
                                        What's on your mind today?
                                    </p>
                                    <p class="mb-0 small text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Remember: While I can offer support and coping strategies, I'm not a replacement
                                        for professional therapy if you need it.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Load messages for current conversation -->
                    {% for chat in messages %}
                    <!-- User Message -->
                    <div class="message-wrapper mb-3">
                        <div class="d-flex align-items-start justify-content-end">
                            <div class="message-content card flex-grow-1"
                                style="max-width: 70%; background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);">
                                <div class="card-body text-white">
                                    <p class="mb-1">{{ chat.user_message }}</p>
                                    <small class="opacity-75">{{ chat.timestamp|date:"H:i" }}</small>
                                </div>
                            </div>
                            <div class="rounded-circle p-2 flex-shrink-0 ms-3"
                                style="background: rgba(255, 255, 255, 0.2);">
                                <i class="bi bi-person" style="color: var(--accent-blue);"></i>
                            </div>
                        </div>
                    </div>

                    <!-- AI Response -->
                    <div class="message-wrapper mb-3">
                        <div class="d-flex align-items-start">
                            <div class="rounded-circle p-2 me-3 flex-shrink-0"
                                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                <i class="bi bi-robot text-white"></i>
                            </div>
                            <div class="message-content card flex-grow-1" style="max-width: 70%;">
                                <div class="card-body">
                                    <p class="mb-1" style="color: var(--text-primary);">{{ chat.ai_response|linebreaksbr|safe }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                       <!-- <small class="text-muted">{{ chat.timestamp|date:"H:i" }}</small>
                                        <small class="text-muted">
                                            Mood:
                                            {% if chat.sentiment == 'positive' %}
                                            <span class="text-success">Positive <i class="bi bi-emoji-smile"></i></span>
                                            {% elif chat.sentiment == 'negative' %}
                                            <span class="text-danger">Negative <i class="bi bi-emoji-frown"></i></span>
                                            {% else %}
                                            <span class="text-muted">Neutral <i class="bi bi-emoji-neutral"></i></span>
                                            {% endif %}
                                        </small> -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Typing Indicator -->
                <div id="typingIndicator" class="message-wrapper mb-3" style="display: none;">
                    <div class="d-flex align-items-start">
                        <div class="rounded-circle p-2 me-3 flex-shrink-0"
                            style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                            <i class="bi bi-robot text-white"></i>
                        </div>
                        <div class="message-content card">
                            <div class="card-body">
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div class="chat-input-area" style="border-top: 1px solid var(--glass-border);">
                <div class="card-body p-3">
                    <form id="chatForm" class="d-flex">
                        {% csrf_token %}
                        <div class="flex-grow-1 me-2">
                            <input type="text" class="form-control" id="messageInput"
                                placeholder="Type your message here..." maxlength="1000" autocomplete="off">
                        </div>
                        <button type="submit" class="btn btn-primary" id="sendButton">
                            <i class="bi bi-send"></i>
                        </button>
                    </form>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            Press Enter to send â€¢ Your conversations are private and secure
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Coping Strategy Modal -->
<div class="modal fade" id="copingStrategyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: var(--text-primary);">
                    <i class="bi bi-lightbulb me-2" style="color: var(--accent-purple);"></i>Coping Strategy
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="color: var(--text-primary);">
                <div id="copingStrategyContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status" style="color: var(--accent-blue);">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="getAnotherStrategy">Get Another</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% endblock %}

{% block extra_css %}
<style>
    /* Hide global navbar and footer for this page */
    .glassmorphic-navbar,
    .glassmorphic-footer {
        display: none !important;
    }

    /* Adjust main container to fill viewport */
    main.container-fluid {
        height: 100vh !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    .chat-main-column {
        height: 100vh !important;
        gap: 0 !important;
    }

    #messagesContainer {
        scroll-behavior: smooth;
    }

    /* Sidebar refinement */
    .chat-history-sidebar {
        background: rgba(15, 23, 42, 0.8) !important;
        backdrop-filter: blur(20px);
        border-right: 1px solid var(--glass-border) !important;
        position: relative;
    }

    .chat-history {
        scrollbar-width: none;
        /* Hide for Firefox */
    }

    .chat-history::-webkit-scrollbar {
        display: none;
        /* Hide for Chrome, Safari, and Opera */
    }

    .sidebar-profile-link {
        margin-top: auto;
    }

    .sidebar-profile {
        transition: background 0.2s ease;
        cursor: pointer;
    }

    .sidebar-profile:hover {
        background: rgba(255, 255, 255, 0.1) !important;
    }

    .chat-history-item {
        border-radius: 8px !important;
        margin: 4px 8px !important;
    }

    .chat-history-item.active {
        background: rgba(255, 255, 255, 0.15) !important;
    }

    /* Header refinement */
    .chat-header-bar {
        background: rgba(15, 23, 42, 0.45) !important;
        backdrop-filter: blur(10px);
        /* ensure dropdowns render above chat bubbles */
        position: relative;
        z-index: 1300;
        overflow: visible;
    }

    /* Ensure dropdown appears above glass containers and messages */
    .glassmorphic-dropdown {
        z-index: 1400 !important;
    }

    /* Aligning padding */
    .chat-header-bar .card-body,
    #messagesContainer,
    .chat-input-area .card-body {
        padding-left: 2rem !important;
        padding-right: 2rem !important;
    }

    @media (max-width: 768px) {

        .chat-header-bar .card-body,
        #messagesContainer,
        .chat-input-area .card-body {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/chat.js' %}"></script>
{% endblock %}